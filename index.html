<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>UmBeGone - The Hesitation Eliminator</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div>
      <div id="titleCard">
        <h1 class="title">UmBeGone</h1>
        <h2 class="subtitle">The Hesitation Eliminator</h2>
      </div>
      <div id="infoBlurb">
        <p class="body">
          Do you hem and haw?  Want to improve your public speaking skills 
          before that big presentation or swoon-worthy <i>love</i> confession?  Well, look no further 
          than UmBeGone!  Just upload audio files of you practicing and we'll not only 
          identify the accuracy of your speech, but highlight exactly which parts
          are tripping you up.
        </p>
      </div>
      <div id="instructions">
        <p class="body">
          Please ensure your audio is in a <b>.wav</b> file recorded with a <b>16khz</b> sample rate
          on a <b>mono</b> channel for accuracy.  We highly suggest you record using a desktop
          audio recorder such as <b>Audacity</b> over a web based recorder.
        </p>
      </div>
      <div>
        <form method = "POST" enctype="multipart/form-data">
        <input type="file" id="input" name="file" accept=".wav" onchange="handleOnChange()">
        </form>
      </div>
      <div>
        <ul id="recordingsList"></ul>
      </div>
    </div>
	<script>
    function handleOnChange() {
      var inputElement = document.getElementById("input");
      var audio = document.createElement("audio");
      var file = inputElement.files[0];
      var url = URL.createObjectURL(file);
      console.log(url);
      audio.setAttribute("controls", "controls");
      audio.setAttribute("src", url);
      audio.setAttribute("type", "audio/wav");

      var deleteButton = document.createElement("button");
      deleteButton.setAttribute("class", "delete");
      deleteButton.innerHTML = "Delete";

      var analysis = document.createElement("div");
      analysis.setAttribute("class", "analysis");
      analysis.innerHTML = "Analyzing your recording...";

      var li = document.createElement('li');
      li.appendChild(audio);
      li.appendChild(analysis);
      li.appendChild(deleteButton);

      var recordingsList = document.getElementById("recordingsList")

      recordingsList.appendChild(li);

      if (!file) {
        console.error("No file selected");
        return;
      }

      var xhr = new XMLHttpRequest();

      xhr.onload = () => {
        console.log(xhr.responseText)
      }

      xhr.open("POST", "http://localhost:8080/recording-api/file");

      var formData = new FormData();
      formData.append('file', file);
      xhr.send(formData);

      xhr.onload = function() {
        var data = xhr.responseText;
        var jsonResponse = JSON.parse(data);
        var numHesitationsJSON = jsonResponse["numHesitations"];
        var numWordsJSON = jsonResponse["numWords"];
        var hesiTimesJSON = jsonResponse["hesiTimes"];
        var accuracyJSON = ((numWordsJSON - numHesitationsJSON) / numWordsJSON) * 100;

        li.setAttribute("id", `${jsonResponse["id"]}`);
        deleteButton.setAttribute("onclick", `handleDeleteOnClick(${jsonResponse["id"]})`);

        var numHesitations = document.createElement("p");
        numHesitations.setAttribute("class", "body");
        numHesitations.innerHTML = `# of Hesitations: ${JSON.stringify(numHesitationsJSON)}`;

        var accuracy = document.createElement("p");
        accuracy.setAttribute("class", "body");
        accuracy.innerHTML = `Accuracy: ${JSON.stringify(accuracyJSON)}%`;

        var hesiTimes = document.createElement("p");
        hesiTimes.setAttribute("class", "body");
        hesiTimes.innerHTML = `Hesitation Timestamps (seconds): ${JSON.stringify(hesiTimesJSON)}`;

        analysis.innerHTML = "";
        analysis.appendChild(numHesitations);
        analysis.appendChild(accuracy);
        analysis.appendChild(hesiTimes);
      }
    }

    function handleDeleteOnClick(clickedId) {
      var toDelete = document.getElementById(clickedId);
      var xhr = new XMLHttpRequest();

      xhr.onload = () => {
        console.log(xhr.responseText)
      }

      xhr.open("DELETE", `http://localhost:8080/recording-api/${clickedId}`);
      xhr.send();
      
      toDelete.remove();
    }
  </script>
  </body>
</html>